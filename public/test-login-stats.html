<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Persist√™ncia de Estat√≠sticas no Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .reset-btn { background-color: #dc3545; }
        .reset-btn:hover { background-color: #c82333; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .stat-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 1.2em;
            color: #007bff;
            margin: 5px 0;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 8px;
        }
        .before { background-color: #fff3cd; }
        .after { background-color: #d4edda; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Teste de Persist√™ncia de Estat√≠sticas no Login</h1>
        <p>Este teste verifica se as estat√≠sticas do usu√°rio s√£o mantidas corretamente durante o processo de login/logout.</p>

        <div class="test-section info">
            <h3>üéÆ Controles de Teste</h3>
            <button onclick="setupTestData()">üìä Configurar Dados de Teste</button>
            <button onclick="simulateLogin()">üîë Simular Login</button>
            <button onclick="simulateLogout()">üö™ Simular Logout</button>
            <button onclick="updateStats()">üìà Atualizar Estat√≠sticas</button>
            <button onclick="checkPersistence()">üîç Verificar Persist√™ncia</button>
            <button onclick="clearAllData()" class="reset-btn">üßπ Limpar Tudo</button>
        </div>

        <div id="test-results"></div>

        <div class="test-section">
            <h3>üìä Estado Atual das Estat√≠sticas</h3>
            <div id="current-stats-display"></div>
            <button onclick="refreshStatsDisplay()">üîÑ Atualizar Exibi√ß√£o</button>
        </div>

        <div class="test-section">
            <h3>üìù Log de Eventos</h3>
            <div id="event-log"></div>
            <button onclick="clearLog()">üßπ Limpar Log</button>
        </div>
    </div>

    <script>
        // Dados de teste
        const testUser = {
            username: 'test_user_stats',
            displayName: 'Test User Stats',
            sessionToken: 'test_session_' + Date.now()
        };

        const initialStats = {
            totalGames: 25,
            wins: 18,
            losses: 7,
            winRate: 72,
            currentStreak: 5,
            bestStreak: 12,
            totalPlayTime: 7200,
            perfectGames: 6,
            averageAttempts: 3.2,
            fastestWin: 28,
            modeStats: {
                daily: { games: 15, wins: 12, bestStreak: 8, averageAttempts: 3.1, perfectGames: 4 },
                infinite: { games: 8, wins: 5, bestStreak: 5, totalSongsCompleted: 45, longestSession: 18 },
                multiplayer: { games: 2, wins: 1, roomsCreated: 1, totalPoints: 220, bestRoundScore: 110 }
            }
        };

        // Fun√ß√µes de utilidade
        function log(message, type = 'info') {
            const logDiv = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `test-section ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
        }

        // Configurar dados de teste
        function setupTestData() {
            log('üìä Configurando dados de teste...', 'info');
            
            const userId = `auth_${testUser.username}`;
            const profileKey = `ludomusic_profile_${userId}`;
            
            const testProfile = {
                id: userId,
                username: testUser.username,
                displayName: testUser.displayName,
                level: 8,
                xp: 2400,
                achievements: ['first_win', 'streak_5', 'perfectionist'],
                stats: { ...initialStats },
                gameHistory: [
                    {
                        id: 'game_1',
                        date: new Date().toISOString(),
                        mode: 'daily',
                        won: true,
                        attempts: 2,
                        playTime: 95,
                        xpGained: 80
                    }
                ],
                franchiseStats: {
                    'Test Game': { gamesPlayed: 5, wins: 4, winRate: 80 }
                },
                badges: ['early_bird', 'perfectionist'],
                titles: [{ id: 'expert', name: 'Expert' }],
                currentTitle: 'expert',
                avatar: null,
                bio: 'Perfil de teste para verifica√ß√£o de persist√™ncia',
                preferences: { showAchievementPopups: true, language: 'pt' },
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                version: '1.0'
            };

            // Salvar no localStorage
            localStorage.setItem(profileKey, JSON.stringify(testProfile));
            
            // Salvar backup
            localStorage.setItem(`ludomusic_profile_backup_${userId}`, JSON.stringify({
                ...testProfile,
                _backupTimestamp: Date.now()
            }));

            log('‚úÖ Dados de teste configurados com sucesso', 'success');
            refreshStatsDisplay();
        }

        // Simular login
        function simulateLogin() {
            log('üîë Simulando processo de login...', 'info');
            
            // Salvar dados de autentica√ß√£o
            localStorage.setItem('ludomusic_session_token', testUser.sessionToken);
            localStorage.setItem('ludomusic_user_data', JSON.stringify({
                username: testUser.username,
                displayName: testUser.displayName
            }));

            // Disparar evento de login
            window.dispatchEvent(new CustomEvent('userLoggedIn', {
                detail: { user: testUser }
            }));

            log('‚úÖ Login simulado - dados de sess√£o salvos', 'success');
            
            // Verificar se os dados persistem
            setTimeout(() => {
                const userId = `auth_${testUser.username}`;
                const profileKey = `ludomusic_profile_${userId}`;
                const profile = localStorage.getItem(profileKey);
                
                if (profile) {
                    const parsedProfile = JSON.parse(profile);
                    log(`‚úÖ Perfil encontrado ap√≥s login: ${parsedProfile.stats.totalGames} jogos`, 'success');
                } else {
                    log('‚ùå Perfil n√£o encontrado ap√≥s login!', 'error');
                }
                
                refreshStatsDisplay();
            }, 500);
        }

        // Simular logout
        function simulateLogout() {
            log('üö™ Simulando processo de logout...', 'info');
            
            // Remover dados de autentica√ß√£o
            localStorage.removeItem('ludomusic_session_token');
            localStorage.removeItem('ludomusic_user_data');

            log('‚úÖ Logout simulado - dados de sess√£o removidos', 'success');
            
            // Verificar se os dados do perfil ainda existem
            setTimeout(() => {
                const userId = `auth_${testUser.username}`;
                const profileKey = `ludomusic_profile_${userId}`;
                const profile = localStorage.getItem(profileKey);
                
                if (profile) {
                    const parsedProfile = JSON.parse(profile);
                    log(`‚úÖ Perfil mantido ap√≥s logout: ${parsedProfile.stats.totalGames} jogos`, 'success');
                } else {
                    log('‚ùå Perfil perdido ap√≥s logout!', 'error');
                }
                
                refreshStatsDisplay();
            }, 500);
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            log('üìà Atualizando estat√≠sticas...', 'info');
            
            const userId = `auth_${testUser.username}`;
            const profileKey = `ludomusic_profile_${userId}`;
            const profile = localStorage.getItem(profileKey);
            
            if (profile) {
                const parsedProfile = JSON.parse(profile);
                
                // Simular um jogo ganho
                parsedProfile.stats.totalGames += 1;
                parsedProfile.stats.wins += 1;
                parsedProfile.stats.currentStreak += 1;
                parsedProfile.stats.winRate = (parsedProfile.stats.wins / parsedProfile.stats.totalGames) * 100;
                parsedProfile.xp += 75;
                parsedProfile.lastUpdated = new Date().toISOString();
                
                // Adicionar ao hist√≥rico
                parsedProfile.gameHistory.unshift({
                    id: 'game_' + Date.now(),
                    date: new Date().toISOString(),
                    mode: 'daily',
                    won: true,
                    attempts: Math.floor(Math.random() * 4) + 1,
                    playTime: Math.floor(Math.random() * 120) + 30,
                    xpGained: 75
                });
                
                localStorage.setItem(profileKey, JSON.stringify(parsedProfile));
                log('‚úÖ Estat√≠sticas atualizadas com sucesso', 'success');
                refreshStatsDisplay();
            } else {
                log('‚ùå Perfil n√£o encontrado para atualiza√ß√£o', 'error');
            }
        }

        // Verificar persist√™ncia
        function checkPersistence() {
            log('üîç Verificando persist√™ncia dos dados...', 'info');
            
            const userId = `auth_${testUser.username}`;
            const profileKey = `ludomusic_profile_${userId}`;
            const backupKey = `ludomusic_profile_backup_${userId}`;
            
            const profile = localStorage.getItem(profileKey);
            const backup = localStorage.getItem(backupKey);
            
            if (profile && backup) {
                try {
                    const parsedProfile = JSON.parse(profile);
                    const parsedBackup = JSON.parse(backup);
                    
                    log('‚úÖ Perfil principal encontrado', 'success');
                    log('‚úÖ Backup encontrado', 'success');
                    
                    // Verificar integridade
                    const issues = [];
                    if (!parsedProfile.stats) issues.push('Stats ausentes');
                    if (!parsedProfile.achievements) issues.push('Achievements ausentes');
                    if (typeof parsedProfile.level !== 'number') issues.push('Level inv√°lido');
                    
                    if (issues.length === 0) {
                        log('‚úÖ Integridade dos dados confirmada', 'success');
                    } else {
                        log(`‚ö†Ô∏è Problemas encontrados: ${issues.join(', ')}`, 'warning');
                    }
                    
                } catch (error) {
                    log(`‚ùå Erro ao verificar dados: ${error.message}`, 'error');
                }
            } else {
                if (!profile) log('‚ùå Perfil principal n√£o encontrado', 'error');
                if (!backup) log('‚ùå Backup n√£o encontrado', 'error');
            }
        }

        // Atualizar exibi√ß√£o das estat√≠sticas
        function refreshStatsDisplay() {
            const statsDiv = document.getElementById('current-stats-display');
            const userId = `auth_${testUser.username}`;
            const profileKey = `ludomusic_profile_${userId}`;
            const profile = localStorage.getItem(profileKey);
            
            if (profile) {
                try {
                    const parsedProfile = JSON.parse(profile);
                    const stats = parsedProfile.stats;
                    
                    statsDiv.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-title">Estat√≠sticas Gerais</div>
                                <div class="stat-value">Jogos: ${stats.totalGames}</div>
                                <div class="stat-value">Vit√≥rias: ${stats.wins}</div>
                                <div class="stat-value">Taxa de Vit√≥ria: ${stats.winRate.toFixed(1)}%</div>
                                <div class="stat-value">Sequ√™ncia Atual: ${stats.currentStreak}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Perfil</div>
                                <div class="stat-value">Level: ${parsedProfile.level}</div>
                                <div class="stat-value">XP: ${parsedProfile.xp}</div>
                                <div class="stat-value">Conquistas: ${parsedProfile.achievements.length}</div>
                                <div class="stat-value">Badges: ${parsedProfile.badges.length}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Modo Di√°rio</div>
                                <div class="stat-value">Jogos: ${stats.modeStats.daily.games}</div>
                                <div class="stat-value">Vit√≥rias: ${stats.modeStats.daily.wins}</div>
                                <div class="stat-value">Melhor Sequ√™ncia: ${stats.modeStats.daily.bestStreak}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">√öltima Atualiza√ß√£o</div>
                                <div class="stat-value">${new Date(parsedProfile.lastUpdated).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    statsDiv.innerHTML = `<div class="test-section error">Erro ao exibir dados: ${error.message}</div>`;
                }
            } else {
                statsDiv.innerHTML = '<div class="test-section warning">Nenhum perfil encontrado</div>';
            }
        }

        // Limpar todos os dados
        function clearAllData() {
            const keys = Object.keys(localStorage).filter(key => 
                key.includes('ludomusic_') || key.includes('test_user_')
            );
            
            keys.forEach(key => localStorage.removeItem(key));
            log(`üßπ ${keys.length} chaves removidas do localStorage`, 'info');
            refreshStatsDisplay();
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üì± P√°gina de teste carregada', 'info');
            refreshStatsDisplay();
        });
    </script>
</body>
</html>
