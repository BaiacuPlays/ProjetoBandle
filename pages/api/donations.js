// API para gerenciar doa√ß√µes e benef√≠cios
import { safeKV } from '../../utils/kv-fix';
import { verifyAuthentication } from '../../utils/auth';
import { isDevelopment, hasKVConfig } from '../../utils/kv-config';
import { Resend } from 'resend';

// Fallback para desenvolvimento local
const localDonations = new Map();

// Inicializar Resend (apenas se a chave estiver configurada)
let resend = null;
if (process.env.RESEND_API_KEY) {
  resend = new Resend(process.env.RESEND_API_KEY);
}

// Fun√ß√£o para gerar c√≥digo de ativa√ß√£o √∫nico
const generateActivationCode = () => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const segments = [];

  for (let i = 0; i < 4; i++) {
    let segment = '';
    for (let j = 0; j < 4; j++) {
      segment += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    segments.push(segment);
  }

  return `LUDO-${segments.join('-')}`;
};

// Configura√ß√£o de benef√≠cios por valor de doa√ß√£o
const DONATION_BENEFITS = {
  5: {
    badges: ['supporter_temp'],
    xpBonus: { multiplier: 1.25, duration: 7 * 24 * 60 * 60 * 1000 }, // 7 dias
    title: 'Apoiador',
    permanent: false
  },
  15: {
    badges: ['supporter_permanent'],
    xpBonus: { multiplier: 1.5, duration: 30 * 24 * 60 * 60 * 1000 }, // 30 dias
    avatars: ['supporter_avatar_1', 'supporter_avatar_2'],
    title: 'Apoiador',
    permanent: true
  },
  30: {
    badges: ['supporter_permanent', 'premium_supporter'],
    xpBonus: { multiplier: 1.5, duration: 30 * 24 * 60 * 60 * 1000 },
    avatars: ['supporter_avatar_1', 'supporter_avatar_2', 'premium_avatar_1'],
    customTitle: true,
    nameColors: ['gold', 'silver'],
    detailedStats: true,
    cloudBackup: true,
    title: 'Apoiador Premium',
    permanent: true
  },
  50: {
    badges: ['supporter_permanent', 'premium_supporter', 'vip_supporter'],
    xpBonus: { multiplier: 2.0, duration: 60 * 24 * 60 * 60 * 1000 }, // 60 dias
    avatars: ['supporter_avatar_1', 'supporter_avatar_2', 'premium_avatar_1', 'vip_avatar_1'],
    customTitle: true,
    nameColors: ['gold', 'silver', 'rainbow', 'platinum'],
    detailedStats: true,
    cloudBackup: true,
    visualEffects: true,
    supporterRanking: true,
    customPlaylist: true,
    extraLives: 3,
    title: 'VIP',
    permanent: true
  }
};

export default async function handler(req, res) {
  // CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method === 'POST') {
    try {
      const { amount, method, timestamp, email } = req.body;

      // BLOQUEAR DOA√á√ïES PIX NESTA API - usar /api/pix-donation-request
      if (method === 'pix' || method === 'pix_pending') {
        return res.status(400).json({
          error: 'Doa√ß√µes PIX devem ser processadas atrav√©s do sistema de verifica√ß√£o manual. Use a API correta.'
        });
      }

      // Verificar se tem autentica√ß√£o (opcional para doa√ß√µes)
      const authResult = await verifyAuthentication(req);
      let userId = null;
      let userEmail = email; // Email fornecido no formul√°rio

      if (authResult.authenticated) {
        // Usu√°rio logado - buscar email do banco de dados
        userId = authResult.userId;

        // Buscar dados completos do usu√°rio para obter o email
        const userKey = `user:${authResult.username.toLowerCase()}`;
        let userData = null;

        if (isDevelopment && !hasKVConfig) {
          const { localUsers } = require('../../utils/storage');
          userData = localUsers.get(userKey);
        } else {
          userData = await safeKV.get(userKey);
        }

        if (userData && userData.email) {
          userEmail = userData.email;
          console.log(`üìß Email encontrado na conta: ${userEmail}`);
        } else {
          console.log('‚ö†Ô∏è Email n√£o encontrado na conta do usu√°rio');
          if (!email) {
            return res.status(400).json({
              error: 'Sua conta n√£o tem email registrado. Por favor, forne√ßa um email para receber o c√≥digo de ativa√ß√£o.'
            });
          } else {
            userEmail = email;
            console.log(`üìß Usando email fornecido: ${userEmail}`);
          }
        }
      } else if (!email) {
        // N√£o logado e sem email - n√£o pode doar
        return res.status(400).json({
          error: 'Email √© obrigat√≥rio para doa√ß√µes. Fa√ßa login ou forne√ßa um email.'
        });
      }

      if (amount === undefined || amount === null || !method) {
        return res.status(400).json({ error: 'Valor e m√©todo s√£o obrigat√≥rios' });
      }

      // Permitir doa√ß√µes de teste (valor 0 ou m√©todo 'test')
      const isTestDonation = method === 'test' || amount === 0;

      // Gerar c√≥digo de ativa√ß√£o √∫nico
      const activationCode = generateActivationCode();

      // Registrar doa√ß√£o
      const donationId = `donation_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const donation = {
        id: donationId,
        userId,
        amount: parseFloat(amount),
        method,
        timestamp: timestamp || new Date().toISOString(),
        activationCode,
        activated: false,
        benefits: []
      };

      // Determinar benef√≠cios baseado no valor
      const benefits = calculateBenefits(parseFloat(amount));
      donation.benefits = benefits;

      // Salvar doa√ß√£o
      const donationKey = `donation:${donationId}`;
      if (isDevelopment && !hasKVConfig) {
        localDonations.set(donationKey, donation);
      } else {
        await safeKV.set(donationKey, donation);
      }

      // Salvar c√≥digo de ativa√ß√£o
      const codeKey = `activation_code:${activationCode}`;
      const codeData = {
        code: activationCode,
        donationId,
        userId,
        amount: parseFloat(amount),
        benefits,
        createdAt: new Date().toISOString(),
        activated: false,
        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 dias
      };

      if (isDevelopment && !hasKVConfig) {
        localDonations.set(codeKey, codeData);
      } else {
        await safeKV.set(codeKey, codeData);
      }

      // Enviar email com c√≥digo de ativa√ß√£o
      const emailData = {
        email: userEmail,
        username: authResult.authenticated ? authResult.username : 'Doador',
        userId: userId
      };
      await sendActivationEmail(emailData, activationCode, parseFloat(amount), benefits, isTestDonation);

      // Registrar no hist√≥rico de doa√ß√µes do usu√°rio (apenas se logado)
      if (userId) {
        await addToUserDonationHistory(userId, donation);
      }

      return res.status(200).json({
        success: true,
        donation,
        activationCode,
        benefits,
        message: 'Doa√ß√£o registrada! C√≥digo de ativa√ß√£o enviado por email.'
      });

    } catch (error) {
      console.error('Erro ao processar doa√ß√£o:', error);
      return res.status(500).json({ error: 'Erro interno do servidor' });
    }
  }

  if (req.method === 'GET') {
    try {
      // Verificar autentica√ß√£o
      const authResult = verifyAuthentication(req);
      if (!authResult.success) {
        return res.status(401).json({ error: 'N√£o autorizado' });
      }

      const userId = authResult.userId;

      // Buscar hist√≥rico de doa√ß√µes do usu√°rio
      const historyKey = `user_donations:${userId}`;
      let donationHistory = [];

      if (isDevelopment && !hasKVConfig) {
        donationHistory = localDonations.get(historyKey) || [];
      } else {
        donationHistory = await safeKV.get(historyKey) || [];
      }

      return res.status(200).json({
        success: true,
        donations: donationHistory
      });

    } catch (error) {
      console.error('Erro ao buscar doa√ß√µes:', error);
      return res.status(500).json({ error: 'Erro interno do servidor' });
    }
  }

  return res.status(405).json({ error: 'M√©todo n√£o permitido' });
}

// Fun√ß√£o para calcular benef√≠cios baseado no valor da doa√ß√£o
function calculateBenefits(amount) {
  const benefits = {
    badges: [],
    xpBonus: null,
    avatars: [],
    nameColors: [],
    features: [],
    title: null,
    permanent: false
  };

  // Encontrar o tier de benef√≠cios apropriado
  const sortedTiers = Object.keys(DONATION_BENEFITS)
    .map(Number)
    .sort((a, b) => b - a); // Ordem decrescente

  for (const tier of sortedTiers) {
    if (amount >= tier) {
      const tierBenefits = DONATION_BENEFITS[tier];
      
      benefits.badges = tierBenefits.badges || [];
      benefits.xpBonus = tierBenefits.xpBonus || null;
      benefits.avatars = tierBenefits.avatars || [];
      benefits.nameColors = tierBenefits.nameColors || [];
      benefits.title = tierBenefits.title || null;
      benefits.permanent = tierBenefits.permanent || false;

      // Adicionar features especiais
      if (tierBenefits.customTitle) benefits.features.push('customTitle');
      if (tierBenefits.detailedStats) benefits.features.push('detailedStats');
      if (tierBenefits.cloudBackup) benefits.features.push('cloudBackup');
      if (tierBenefits.visualEffects) benefits.features.push('visualEffects');
      if (tierBenefits.supporterRanking) benefits.features.push('supporterRanking');
      if (tierBenefits.customPlaylist) benefits.features.push('customPlaylist');
      if (tierBenefits.extraLives) benefits.extraLives = tierBenefits.extraLives;

      break;
    }
  }

  return benefits;
}

// Fun√ß√£o para aplicar benef√≠cios ao perfil do usu√°rio
async function applyBenefitsToProfile(userId, benefits) {
  try {
    const profileKey = `profile:${userId}`;
    let profile = null;

    if (isDevelopment && !hasKVConfig) {
      // Em desenvolvimento, simular
      console.log(`üéÅ [SIMULADO] Aplicando benef√≠cios para ${userId}:`, benefits);
      return true;
    } else {
      profile = await safeKV.get(profileKey);
    }

    if (!profile) {
      console.log('Perfil n√£o encontrado para aplicar benef√≠cios');
      return false;
    }

    // Inicializar campos de doa√ß√£o se n√£o existirem
    if (!profile.donationBenefits) {
      profile.donationBenefits = {
        badges: [],
        activeXpBonus: null,
        unlockedAvatars: [],
        nameColors: [],
        features: [],
        customTitle: null,
        extraLives: 0
      };
    }

    // Aplicar badges
    if (benefits.badges) {
      benefits.badges.forEach(badge => {
        if (!profile.donationBenefits.badges.includes(badge)) {
          profile.donationBenefits.badges.push(badge);
        }
      });
    }

    // Aplicar b√¥nus de XP
    if (benefits.xpBonus) {
      profile.donationBenefits.activeXpBonus = {
        multiplier: benefits.xpBonus.multiplier,
        expiresAt: new Date(Date.now() + benefits.xpBonus.duration).toISOString()
      };
    }

    // Aplicar avatars desbloqueados
    if (benefits.avatars) {
      benefits.avatars.forEach(avatar => {
        if (!profile.donationBenefits.unlockedAvatars.includes(avatar)) {
          profile.donationBenefits.unlockedAvatars.push(avatar);
        }
      });
    }

    // Aplicar cores de nome
    if (benefits.nameColors) {
      profile.donationBenefits.nameColors = [...new Set([
        ...profile.donationBenefits.nameColors,
        ...benefits.nameColors
      ])];
    }

    // Aplicar features
    if (benefits.features) {
      profile.donationBenefits.features = [...new Set([
        ...profile.donationBenefits.features,
        ...benefits.features
      ])];
    }

    // Aplicar vidas extras
    if (benefits.extraLives) {
      profile.donationBenefits.extraLives = Math.max(
        profile.donationBenefits.extraLives || 0,
        benefits.extraLives
      );
    }

    // Aplicar t√≠tulo
    if (benefits.title) {
      profile.donationBenefits.customTitle = benefits.title;
    }

    // Marcar como apoiador
    profile.isSupporter = true;
    profile.supporterSince = profile.supporterSince || new Date().toISOString();

    // Salvar perfil atualizado
    await safeKV.set(profileKey, profile);

    console.log(`‚úÖ Benef√≠cios aplicados para ${userId}`);
    return true;

  } catch (error) {
    console.error('Erro ao aplicar benef√≠cios:', error);
    return false;
  }
}

// Fun√ß√£o para adicionar doa√ß√£o ao hist√≥rico do usu√°rio
async function addToUserDonationHistory(userId, donation) {
  try {
    const historyKey = `user_donations:${userId}`;
    let history = [];

    if (isDevelopment && !hasKVConfig) {
      history = localDonations.get(historyKey) || [];
    } else {
      history = await safeKV.get(historyKey) || [];
    }

    // Adicionar nova doa√ß√£o ao in√≠cio do array
    history.unshift({
      id: donation.id,
      amount: donation.amount,
      method: donation.method,
      timestamp: donation.timestamp,
      benefits: donation.benefits
    });

    // Manter apenas as √∫ltimas 50 doa√ß√µes
    if (history.length > 50) {
      history = history.slice(0, 50);
    }

    // Salvar hist√≥rico atualizado
    if (isDevelopment && !hasKVConfig) {
      localDonations.set(historyKey, history);
    } else {
      await safeKV.set(historyKey, history);
    }

    return true;
  } catch (error) {
    console.error('Erro ao salvar hist√≥rico de doa√ß√µes:', error);
    return false;
  }
}

// Fun√ß√£o para enviar email de ativa√ß√£o
async function sendActivationEmail(emailData, activationCode, amount, benefits, isTestDonation = false) {
  try {
    if (!resend) {
      console.log(`üìß [SIMULADO] Email de ativa√ß√£o para ${emailData.username}:`);
      console.log(`   Email: ${emailData.email}`);
      console.log(`   C√≥digo: ${activationCode}`);
      console.log(`   Valor: R$ ${amount} ${isTestDonation ? '(TESTE)' : ''}`);
      console.log(`   Benef√≠cios: ${benefits.badges?.join(', ') || 'Nenhum'}`);
      return true;
    }

    if (!emailData.email) {
      console.error('Email n√£o fornecido para envio');
      return false;
    }

    console.log(`üìß Enviando email de ativa√ß√£o para: ${emailData.email}`);
    console.log(`üìß Usu√°rio: ${emailData.username}`);
    console.log(`üìß C√≥digo: ${activationCode}`);

    // Preparar lista de benef√≠cios para o email
    const benefitsList = [];
    if (benefits.badges) benefitsList.push(`üèÜ Badges: ${benefits.badges.join(', ')}`);
    if (benefits.xpBonus) benefitsList.push(`‚ö° B√¥nus XP: ${benefits.xpBonus.multiplier}x por ${Math.round(benefits.xpBonus.duration / (24 * 60 * 60 * 1000))} dias`);
    if (benefits.avatars) benefitsList.push(`üé® Avatars: ${benefits.avatars.length} novos`);
    if (benefits.nameColors) benefitsList.push(`‚ú® Cores: ${benefits.nameColors.join(', ')}`);
    if (benefits.features) benefitsList.push(`üîß Features: ${benefits.features.join(', ')}`);
    if (benefits.extraLives) benefitsList.push(`‚ù§Ô∏è Vidas extras: ${benefits.extraLives}`);

    const emailHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #1a1a1a; color: #fff; border-radius: 10px; overflow: hidden;">
        <div style="background: linear-gradient(45deg, #ff6b6b, #ffd700); padding: 2rem; text-align: center;">
          <h1 style="margin: 0; font-size: 2rem;">üéµ LudoMusic</h1>
          <h2 style="margin: 0.5rem 0 0 0; font-size: 1.5rem;">${isTestDonation ? 'Doa√ß√£o de Teste!' : 'Obrigado pela sua doa√ß√£o!'}</h2>
        </div>

        <div style="padding: 2rem;">
          <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
            Ol√° <strong>${emailData.username}</strong>! üëã
          </p>

          <p style="margin-bottom: 1.5rem;">
            ${isTestDonation
              ? `Esta √© uma <strong>doa√ß√£o de teste</strong> de R$ ${amount} para verificar se o sistema est√° funcionando corretamente! üß™`
              : `Muito obrigado pela sua doa√ß√£o de <strong>R$ ${amount}</strong>! Sua contribui√ß√£o √© fundamental para manter o LudoMusic funcionando e crescendo.`
            }
          </p>

          <div style="background: #2a2a2a; padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0; text-align: center;">
            <h3 style="margin: 0 0 1rem 0; color: #ffd700;">üéÅ Seu C√≥digo de Ativa√ß√£o</h3>
            <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; color: #ff6b6b;">
              ${activationCode}
            </div>
            <p style="margin: 1rem 0 0 0; font-size: 0.9rem; color: #ccc;">
              Use este c√≥digo no site para ativar seus benef√≠cios
            </p>
          </div>

          <h3 style="color: #ffd700; margin: 1.5rem 0 1rem 0;">üéÅ Benef√≠cios que voc√™ receber√°:</h3>
          <ul style="list-style: none; padding: 0;">
            ${benefitsList.map(benefit => `<li style="margin: 0.5rem 0; padding: 0.5rem; background: #2a2a2a; border-radius: 5px;">${benefit}</li>`).join('')}
          </ul>

          <div style="background: #2a2a2a; padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0;">
            <h4 style="margin: 0 0 1rem 0; color: #ffd700;">üìù Como ativar seus benef√≠cios:</h4>
            <ol style="margin: 0; padding-left: 1.5rem;">
              <li style="margin: 0.5rem 0;">Acesse o LudoMusic</li>
              <li style="margin: 0.5rem 0;">Fa√ßa login na sua conta</li>
              <li style="margin: 0.5rem 0;">Clique no seu perfil (√≠cone do usu√°rio)</li>
              <li style="margin: 0.5rem 0;">V√° na aba "Configura√ß√µes"</li>
              <li style="margin: 0.5rem 0;">Clique em "Ativar C√≥digo de Benef√≠cios"</li>
              <li style="margin: 0.5rem 0;">Digite o c√≥digo: <strong>${activationCode}</strong></li>
              <li style="margin: 0.5rem 0;">Aproveite seus benef√≠cios! üéâ</li>
            </ol>
          </div>

          <p style="margin: 1.5rem 0; font-size: 0.9rem; color: #ccc;">
            ‚è∞ Este c√≥digo expira em 30 dias. N√£o se esque√ßa de ativ√°-lo!
          </p>

          <div style="text-align: center; margin: 2rem 0;">
            <a href="${process.env.NEXT_PUBLIC_BASE_URL || 'https://ludomusic.xyz'}"
               style="background: linear-gradient(45deg, #ff6b6b, #ffd700); color: white; text-decoration: none; padding: 1rem 2rem; border-radius: 10px; font-weight: bold; display: inline-block;">
              üéÆ Ativar Benef√≠cios Agora
            </a>
          </div>

          <p style="text-align: center; margin: 2rem 0; color: #ccc; font-size: 0.9rem;">
            Muito obrigado por apoiar o LudoMusic! üíù<br>
            Sua contribui√ß√£o faz toda a diferen√ßa!
          </p>
        </div>
      </div>
    `;

    // Enviar email
    const fromEmail = process.env.FROM_EMAIL || 'noreply@ludomusic.xyz';
    const result = await resend.emails.send({
      from: `LudoMusic <${fromEmail}>`,
      to: emailData.email,
      subject: `üéÅ Seus benef√≠cios LudoMusic - C√≥digo: ${activationCode}`,
      html: emailHtml
    });

    console.log(`‚úÖ Email de ativa√ß√£o enviado para ${emailData.email}`);
    console.log(`‚úÖ Resultado do envio:`, result);
    return true;

  } catch (error) {
    console.error('Erro ao enviar email de ativa√ß√£o:', error);
    return false;
  }
}
